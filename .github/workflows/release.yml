name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            platform: linux/amd64
          - os: windows-latest
            platform: windows/amd64

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      # ── Linux dependencies ────────────────────────────────────────────────
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            libfuse2

      - name: Bundle backend files
        run: make bundle

      - name: Set version in wails.json
        shell: bash
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          jq --arg v "$VERSION" '.info.productVersion = $v' wails.json > tmp.json && mv tmp.json wails.json

      # ── Windows: NSIS installer ──────────────────────────────────────────
      - name: Install NSIS (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Try chocolatey first, fall back to direct download if it fails
          $nsisInstalled = $false
          try {
            choco install nsis --no-progress -y
            if ((Test-Path "C:\Program Files (x86)\NSIS\makensis.exe")) {
              $nsisInstalled = $true
            }
          } catch {}
          if (-not $nsisInstalled) {
            Write-Host "Chocolatey failed, downloading NSIS directly..."
            $url = "https://sourceforge.net/projects/nsis/files/NSIS%203/3.10/nsis-3.10-setup.exe/download"
            Invoke-WebRequest -Uri $url -OutFile nsis-setup.exe -MaximumRedirection 5
            Start-Process -FilePath .\nsis-setup.exe -ArgumentList "/S" -Wait
          }
          if (-not (Test-Path "C:\Program Files (x86)\NSIS\makensis.exe")) {
            throw "NSIS installation failed: makensis.exe not found"
          }
          echo "C:/Program Files (x86)/NSIS" | Out-File -Append -FilePath $env:GITHUB_PATH

      - name: Build Windows + NSIS installer
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $env:PATH = "C:\Program Files (x86)\NSIS;$env:PATH"
          wails build -clean -platform windows/amd64 -nsis -ldflags "-X 'main.Version=${{ github.ref_name }}'"
          if (-not (Test-Path "build\bin\*-installer.exe")) {
            throw "NSIS installer was not produced"
          }

      - name: Upload Windows artifact
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: scdl-web-windows-amd64-installer
          path: build/bin/*-installer.exe
          if-no-files-found: error

      # ── Linux: AppImage (both WebKit variants) ─────────────────────────
      - name: Download appimagetool
        if: runner.os == 'Linux'
        run: |
          wget -q \
            https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage \
            -O /usr/local/bin/appimagetool
          chmod +x /usr/local/bin/appimagetool

      # Build 1: webkit2gtk-4.0 (Ubuntu 22.04, Debian 12)
      - name: Build Linux (webkit2gtk-4.0)
        if: runner.os == 'Linux'
        run: xvfb-run wails build -clean -platform linux/amd64 -ldflags "-X 'main.Version=${{ github.ref_name }}'"

      - name: Package AppImage (webkit2gtk-4.0)
        if: runner.os == 'Linux'
        run: |
          mkdir -p AppDir/usr/bin
          cp build/bin/scdl-web AppDir/usr/bin/scdl-web
          cp build/appicon.png AppDir/scdl-web.png
          cp build/linux/scdl-web.desktop AppDir/scdl-web.desktop
          sed -i 's|Exec=.*|Exec=scdl-web|' AppDir/scdl-web.desktop
          ARCH=x86_64 appimagetool AppDir build/bin/scdl-web-linux-amd64.AppImage

      # Upload 4.0 NOW — before the 4.1 build with -clean wipes build/bin/
      - name: Upload Linux artifact (webkit2gtk-4.0)
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: scdl-web-linux-amd64-appimage
          path: build/bin/scdl-web-linux-amd64.AppImage
          if-no-files-found: error

      # Build 2: webkit2gtk-4.1 (Arch, Fedora 39+, Ubuntu 24.04+)
      - name: Build Linux (webkit2gtk-4.1)
        if: runner.os == 'Linux'
        run: xvfb-run wails build -clean -tags webkit2_41 -platform linux/amd64 -ldflags "-X 'main.Version=${{ github.ref_name }}' -X 'main.LinuxAssetName=scdl-web-linux-amd64-webkit4.1.AppImage'"

      - name: Package AppImage (webkit2gtk-4.1)
        if: runner.os == 'Linux'
        run: |
          rm -rf AppDir
          mkdir -p AppDir/usr/bin
          cp build/bin/scdl-web AppDir/usr/bin/scdl-web
          cp build/appicon.png AppDir/scdl-web.png
          cp build/linux/scdl-web.desktop AppDir/scdl-web.desktop
          sed -i 's|Exec=.*|Exec=scdl-web|' AppDir/scdl-web.desktop
          ARCH=x86_64 appimagetool AppDir build/bin/scdl-web-linux-amd64-webkit4.1.AppImage

      - name: Upload Linux artifact (webkit2gtk-4.1)
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: scdl-web-linux-amd64-webkit41-appimage
          path: build/bin/scdl-web-linux-amd64-webkit4.1.AppImage
          if-no-files-found: error

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect release files
        run: |
          mkdir -p release
          find artifacts -type f -exec cp {} release/ \;
          ls -la release/

      - uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: release/*
